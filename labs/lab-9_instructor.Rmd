---
title: "Lab 9: Paired samples *t*-tests"
output: 
  html_document: 
    theme: cosmo
    toc: yes
    toc_depth: 3
    toc_float: TRUE
---

```{r setup, include = FALSE}
# set chunk options
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

# suppress scientific notation
options(scipen = 999)

#load required packages for .Rmd set-up
library(here) # for finding paths
```

# Purpose

Today's lab will guide you through the process of conducting a paired samples *t*-test. As we did with [one-sample and independent samples *t*-tests](https://uopsych.github.io/psy611/labs/lab-8.html){target="_blank"}, we will compare functions from the `{stats}` and `{lsr}` packages, and we will go over how to plot paired-samples data using `{ggpubr}`. At the end of today's lab, you will apply what you learned to a new data set in the [minihacks](#minihacks).


To quickly navigate to the desired section, click one of the following links:

1. [The Data](#data)
2. [Data exploration](#explore)


* You will need several packages to be loaded in order to follow along. Go ahead and load them now by running the following code (and be sure to install any packages that you don't already have installed):

```{r}
#load required packages
library(tidyverse) # includes dplyr and ggplot2 functions
library(lsr) # includes t-test functions
library(stats) # includes different t-test functions
library(ggpubr) # for plotting
library(rio) # for importing data
library(psych) # for descriptives
```

***

# The Data {#data}

To illustrate how paired-samples *t*-tests work, we are going to walk through [an example from your textbook](https://learningstatisticswithr-bookdown.netlify.com/ttest.html#pairedsamplesttest){target="_blank"}. In this example, the data comes from Dr. Chico's introductory statistics class, in which students take two tests over the course of the semester. Dr. Chico gives notoriously difficult exams with the intention of motivating her students to work hard in the class and thus learn as much as possible. Dr. Chico's theory is that the first test will serve as a "wake up call" for her students, such that when they realize how difficult the class actually is they will be motivated to study harder and earn a higher grade on the second test than they got on the first test.

You can load in the data from this example by running the following code:

```{r}
# wide format
chico_wide <- import("https://raw.githubusercontent.com/uopsych/psy611/master/labs/resources/lab9/data/chico_wide.csv")

# long format
chico_long <- import("https://raw.githubusercontent.com/uopsych/psy611/master/labs/resources/lab9/data/chico_long.csv")
```

**Note:** You should now have 2 versions of the same data set now loaded into your global environment. The only difference in these versions of the data is their "shape" -- one is "wide" and the other is "long". In the wide form, every row corresponds to a unique *person*; in the long form, every row corresponds to a unique *measurement*.

* To get a sense of the differences between these two versions of the data, see below:

```{r}
head(chico_wide)

head(chico_long)
```

* For now, we are going to work with `chico_wide`. Later on we will discuss more about how to deal with wide vs. long format. 

***

# Data exploration {#explore}

Let's take a closer look at the data before we actually run a *t*-test to see what might be going on...

```{r}
describe(chico_wide)
```

**Question:** What do you notice about the means and standard deviations on the two groups? Can we conclude anything?

* What if we look at the data graphically? 

<center>
![](resources/lab9/lsr_figs/line.png)
</center>


* Based on the descriptive statistics and the plot above with widely overlapping confidence intervals, it might seem intuitive to think that the improvement in test scores from Test 1 to Test 2 is due entirely to chance. However, if we look at the data in a different way, we will see why this impression is not correct...

<center>
![](resources/lab9/lsr_figs/scatter.png)
</center>

**Question**: What do you notice about the pattern this plot shows?

* Let's create a new variable to represent the *improvement* for each student from Test 1 to Test 2.

```{r}
chico_wide <- chico_wide %>% 
  mutate(diff = grade_test2 - grade_test1)

head(chico_wide)
```

* Now let's look at a histogram of these improvement scores:

<center>
![](resources/lab9/lsr_figs/hist.png)
</center>


* Notice that the vast majority of students have an improvement score above 0; in other words, virtually all students improved their score to some extent from Test 1 to Test 2. 

***

# Paired samples *t*-test in R

## What is a paired samples *t*-test?

* In our example above, we created a new variable, `chico_wide$improvement`, that represents the *difference* between each student's score on Test 1 and Test 2. 

* More generally, if $X_{i1}$ is the score that the $i$-th participant obtained on the first variable, and $X_{i2}$ is the score that the same person obtained on the second one, then the difference score is:

$$ \Delta_i = X_{i1} - X_{i2}$$

* The population mean of difference scores could be represented as:

$$ \mu_\Delta = \mu_1  - \mu_2$$ 

* Fundamentally, paired samples *t*-tests operate at the level of difference scores. Accordingly, we can state the null and alternative hypotheses for a paired-samples *t*-test as follows:

$$ H_0: \mu_\Delta = 0 $$ 
$$ H_1: \mu_\Delta \neq 0 $$ 

* Note that so far this looks really similar to a one-sample *t*-test; in this case, we are testing whether the mean of some set of difference scores is different from 0. As such, our *t* statistics for a paired samples *t*-test looks similar to what we have already learned for a one-sample *t*-test:

$$t = \frac{\bar \Delta}{SE(\bar \Delta)}$$
which is the same as
$$t = \frac{\bar \Delta}{\hat \sigma_\Delta / \sqrt{N}}$$

## Arithmetic
```{r}
chico_mean   <- mean(chico_wide$diff)
  
chico_sd     <- sd(chico_wide$diff)
  
chico_n      <- length(chico_wide$diff)

chico_df     <- chico_n - 1

chico_se     <- chico_sd / sqrt(chico_n)
  
chico_t      <- chico_mean / chico_se
  
chico_p      <- pt(q = abs(chico_t), df = chico_n - 1, lower.tail = FALSE) * 2

chico_ci_low <- chico_mean + chico_se * qt(p = .025, df = chico_df, lower.tail = TRUE)

chico_ci_up  <- chico_mean + chico_se * qt(p = .975, df = chico_df, lower.tail = TRUE)

chico_d      <- chico_mean / chico_sd

```

## One-sample *t*-test of difference scores

```{r}
t.test(x = chico_wide$diff, mu = 0)
```


```{r}
oneSampleTTest(x = chico_wide$diff, mu = 0)
```


## `lsr::pairedSamplesTTest()`

```{r}
pairedSamplesTTest(formula = ~ grade_test2 + grade_test1, # one-sided formula
                   data = chico_wide # wide format
                  )
```


### Long vs. wide format

```{r}
# grouping variable (time) must be a factor
chico_long <- chico_long %>% 
  mutate(time = as.factor(time))

pairedSamplesTTest(formula = grade ~ time, # two-sided formula
                   data = chico_long, # long format
                   id = "id" # name of the id variable
                   )
```

## `stats::t.test()`

```{r}
t.test(x = chico_wide$grade_test1,
       y = chico_wide$grade_test2,
       paired = TRUE)
```


***

# Effect size

$$ d = \frac{\bar \Delta}{\hat \sigma_\Delta} $$

where $\hat \sigma_\Delta$ is the standard deviation of the difference scores

```{r}
lsr::cohensD(x = chico_wide$grade_test1,
        y = chico_wide$grade_test2, 
        method = "paired")
```

***

# Plotting paired-samples data

```{r}
ggpaired(chico_long, x = "time", y = "grade",
         color = "time", line.color = "gray", line.size = 0.4,
         palette = "jco")
```

***

# Minihacks {#minihacks}

You are welcome to work with a partner or in a small group of 2-3 people. Please feel free to ask the lab leader any questions you might have!

## Minihack 1

A clinical psychologist wants to know whether a new cognitive-behavioral therapy program helps alleviate anxiety.  He enrolls 12 individuals diagnosed with an anxiety disorder in a 6-week CBT program. Participants are given an Anxiety Scale before they begin and after they complete treatment.  

Import the data by running the the following code:

```{r}
cbt_data <- import("https://raw.githubusercontent.com/uopsych/psy611/master/labs/resources/lab9/data/cbt_data.csv")
```

1. What's the research question?

2. Run a paired-samples *t*-test

3. Calcualate an effect size

***

## Minihack 2

***

## Minihack 3